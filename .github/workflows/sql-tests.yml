name: SQL Tests (manual or gated)

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'tests/sql/**'
      - 'scripts/run_sql_tests.py'
      - '.github/workflows/sql-tests.yml'

jobs:
  sql-tests:
    runs-on: ubuntu-latest
    env:
      RS_HOST: ${{ secrets.RS_HOST }}
      RS_USER: ${{ secrets.RS_USER }}
      RS_PASSWORD: ${{ secrets.RS_PASSWORD }}
      RS_DB: ${{ secrets.RS_DB }}
      RS_PORT: ${{ secrets.RS_PORT }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      - name: Gate on secrets
        id: gate
        run: |
          if [ -z "${RS_HOST}" ] || [ -z "${RS_USER}" ] || [ -z "${RS_PASSWORD}" ]; then
            echo "Secrets not provided; skipping tests.";
            echo "skip=true" >> $GITHUB_OUTPUT;
          fi
      - name: Install deps
        if: steps.gate.outputs.skip != 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      - name: Run SQL tests
        if: steps.gate.outputs.skip != 'true'
        run: |
          python scripts/run_sql_tests.py

