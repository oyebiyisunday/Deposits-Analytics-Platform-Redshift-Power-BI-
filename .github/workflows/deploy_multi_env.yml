name: Terraform Multi-Env Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options: [dev, stage, prod]

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.9.5
      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ vars.AWS_REGION || 'us-east-1' }}
      - name: Select backend config
        id: cfg
        run: |
          ENV=${{ github.event.inputs.environment }}
          case "$ENV" in
            dev)   echo "file=infra/terraform/backend-dev.hcl.example"   >> $GITHUB_OUTPUT ;;
            stage) echo "file=infra/terraform/backend-stage.hcl.example" >> $GITHUB_OUTPUT ;;
            prod)  echo "file=infra/terraform/backend-prod.hcl.example"  >> $GITHUB_OUTPUT ;;
          esac
      - name: Terraform init/plan/apply
        run: |
          terraform -chdir=infra/terraform init -backend-config=${{ steps.cfg.outputs.file }}
          terraform -chdir=infra/terraform plan -var-file=terraform.tfvars -out tfplan
          terraform -chdir=infra/terraform apply -auto-approve tfplan

